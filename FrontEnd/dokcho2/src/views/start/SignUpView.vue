<template>
  <div class="background">
    <div class="signuppage">
      <div class="signuppage__left">
        <div class="termsofservice">
          <div class="termsofservice__text">
            ì œ 1 ì¥ ì´ ì¹™<br />ì œ 1 ì¡° (ëª©ì )<br />ì´ ì•½ê´€ì€ {ë…ì´ˆë„ê°}(ì´í•˜
            "ì‚¬ì´íŠ¸"ë¼ í•©ë‹ˆë‹¤)ì—ì„œ ì œê³µí•˜ëŠ” ì¸í„°ë„·ì„œë¹„ìŠ¤(ì´í•˜ "ì„œë¹„ìŠ¤"ë¼
            í•©ë‹ˆë‹¤)ì˜ ì´ìš© ì¡°ê±´ ë° ì ˆì°¨ì— ê´€í•œ ê¸°ë³¸ì ì¸ ì‚¬í•­ì„ ê·œì •í•¨ì„ ëª©ì ìœ¼ë¡œ
            í•©ë‹ˆë‹¤.<br />ì œ 2ì¡° (ì•½ê´€ì˜ íš¨ë ¥ ë° ë³€ê²½)<br />â‘  ì´ ì•½ê´€ì€ ì„œë¹„ìŠ¤
            í™”ë©´ì´ë‚˜ ê¸°íƒ€ì˜ ë°©ë²•ìœ¼ë¡œ ì´ìš©ê³ ê°ì—ê²Œ ê³µì§€í•¨ìœ¼ë¡œì¨ íš¨ë ¥ì„
            ë°œìƒí•©ë‹ˆë‹¤.<br />â‘¡ ì‚¬ì´íŠ¸ëŠ” ì´ ì•½ê´€ì˜ ë‚´ìš©ì„ ë³€ê²½í•  ìˆ˜ ìˆìœ¼ë©°,
            ë³€ê²½ëœ ì•½ê´€ì€ ì œ1í•­ê³¼ ê°™ì€ ë°©ë²•ìœ¼ë¡œ ê³µì§€ ë˜ëŠ” í†µì§€í•¨ìœ¼ë¡œì¨ íš¨ë ¥ì„
            ë°œìƒí•©ë‹ˆë‹¤.<br />ì œ 3 ì¡° (ìš©ì–´ì˜ ì •ì˜) ì´ ì•½ê´€ì—ì„œ ì‚¬ìš©í•˜ëŠ” ìš©ì–´ì˜
            ì •ì˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.<br />â‘  íšŒì› : ì‚¬ì´íŠ¸ì™€ ì„œë¹„ìŠ¤ ì´ìš©ê³„ì•½ì„
            ì²´ê²°í•˜ê±°ë‚˜ ì´ìš©ì ì•„ì´ë””(ID)ë¥¼ ë¶€ì—¬ë°›ì€ ê°œì¸ ë˜ëŠ” ë‹¨ì²´ë¥¼
            ë§í•©ë‹ˆë‹¤.<br />
          </div>
        </div>
        <div class="agreement">
          <div class="checkbox__label">
            <label for="checkbox">ì•½ê´€ì— ë™ì˜í•˜ê¸°</label>
          </div>
          <input
            id="checkbox"
            class="checkbox"
            type="checkbox"
            v-model="termsAgreed"
          />
        </div>
        <div class="checkbox__text">
          <!-- <span class="allowedtext" v-if="termsAgreed"
            >íšŒì›ê°€ì…ì„ ê³„ì†í•´ì„œ ì§„í–‰í•´ì£¼ì„¸ìš”ğŸ˜</span
          > -->
          <span class="warningtext" v-if="!termsAgreed"
            >ì•½ê´€ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.</span
          >
        </div>
      </div>
      <div class="signuppage__right">
        <div class="logo">
          <!-- <img class="logo__img" src="@/assets/dokcho_logo.png" alt="" /> -->
        </div>
        <div class="oktext">
          <span>ì•„ì´ë”” : ì˜ë¬¸ìë‚˜ ìˆ«ìì˜ ì¡°í•©ìœ¼ë¡œ 5~20ìë¦¬</span>
        </div>
        <div class="username__input">
          <div class="usr__ipt">
            <input
              @keyup="checkUsername()"
              v-model="username"
              placeholder="ì•„ì´ë””"
            />
            <div class="oktext">
              <span
                class="allowedtext"
                v-if="this.isUsernameChecked && !this.usernameDuplicate"
                >ì´ ì•„ì´ë””ëŠ” ì‚¬ìš©í•˜ì…”ë„ ì¢‹ì•„ìš” ğŸ‘Œ</span
              >
              <span
                class="warningtext"
                v-else-if="this.isUsernameChecked && this.usernameDuplicate"
                >ì•„ì´ë””ê°€ ì¤‘ë³µì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!</span
              >
              <span
                class="warningtext"
                v-else-if="!this.isUsernameChecked && !this.usernameDuplicate"
                >ì•„ì´ë”” ìƒì„± ì¡°ê±´ì„ í™•ì¸í•´ì£¼ì„¸ìš” ğŸ™</span
              >
              <span
                class="warningtext"
                v-else-if="this.username !== undefined && this.username !== ''"
                >ì•„ì´ë”” ìƒì„± ì¡°ê±´ì„ í™•ì¸í•´ì£¼ì„¸ìš”</span
              >
            </div>
          </div>

          <div class="btn">
            <button
              class="duplicate__button"
              type="submit"
              @click="isUsernameDuplicate()"
            >
              ì•„ì´ë””ì¤‘ë³µí™•ì¸
            </button>
          </div>
        </div>
        <div class="email__input">
          <div class="email__ipt">
            <input @keyup="checkEmail()" v-model="email" placeholder="ì´ë©”ì¼" />
            <div class="oktext">
              <span
                class="allowedtext"
                v-if="this.isEmailChecked && !this.emailDuplicate"
                >ì´ ì´ë©”ì¼ì€ ì‚¬ìš©í•˜ì…”ë„ ì¢‹ì•„ìš” ğŸ‘Œ</span
              >
              <span
                class="warningtext"
                v-else-if="this.isEmailChecked && this.emailDuplicate"
                >ì´ë©”ì¼ ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”!
              </span>
              <span
                class="warningtext"
                v-else-if="!this.isEmailChecked && !this.emailDuplicate"
                >ì´ë©”ì¼ ì–‘ì‹ì— ë§ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”!</span
              >
              <span
                class="warningtext"
                v-else-if="this.email !== undefined && this.email !== ''"
                >ì´ë©”ì¼ ì–‘ì‹ì— ë§ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”!</span
              >
            </div>
          </div>

          <div class="btn">
            <button
              class="duplicate__button"
              type="submit"
              @click="isEmailDuplicate()"
            >
              ì´ë©”ì¼ì¤‘ë³µí™•ì¸
            </button>
          </div>
        </div>
        <br />
        <div>
          <div class="oktext">
            <span>ë¹„ë°€ë²ˆí˜¸ : ì˜ë¬¸ì+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì ì¡°í•©ìœ¼ë¡œ 8~25ìë¦¬</span>
          </div>
          <input
            @keyup="checkPassword()"
            v-model="password"
            type="password"
            placeholder="ë¹„ë°€ë²ˆí˜¸"
          />
          <div class="oktext">
            <span class="allowedtext" v-if="this.isPasswordChecked"
              >ì´ ë¹„ë°€ë²ˆí˜¸ëŠ” ì‚¬ìš©í•˜ì…”ë„ ì¢‹ì•„ìš” ğŸ‘Œ</span
            >
            <span
              class="warningtext"
              v-else-if="
                !this.isPasswordChecked &&
                this.password !== undefined &&
                this.password !== ''
              "
              >ë¹„ë°€ë²ˆí˜¸ ìƒì„± ì¡°ê±´ì„ í™•ì¸í•´ì£¼ì„¸ìš” ğŸ™</span
            >
          </div>
        </div>
        <div>
          <input
            @keyup.enter="signup()"
            v-model="password2"
            type="password"
            placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
          />
          <div class="oktext">
            <span
              class="warningtext"
              v-if="
                this.password !== this.password2 &&
                this.password2 !== undefined &&
                this.password2 !== ''
              "
              >ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš” ğŸ™</span
            >
            <span
              class="allowedtext"
              v-else-if="this.password === this.password2"
              >ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‘Œ</span
            >
          </div>
        </div>
        <div class="signup">
          <button class="cancel__btn" type="submit" @click="cancel()">
            ì·¨ì†Œ
          </button>
          <button class="signup__btn" type="submit" @click="signup()">
            íšŒì›ê°€ì…
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import axios from 'axios'
import { BASE_URL } from '@/constant/BASE_URL'
import { mapActions, mapGetters } from 'vuex'
import swal from 'sweetalert'

var usernameCheck = /^[a-zA-Z0-9]{5,20}$/
var passwordCheck = /^(?=.*[a-zA-Z])(?=.*[!@#$%^*+=-])(?=.*[0-9]).{8,25}$/
var emailCheck =
  /[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/

export default {
  name: 'SignUpView',
  data() {
    return {
      email: this.email,
      password: this.password,
      password2: this.password2,
      username: this.username,
      emailDuplicate: true,
      usernameDuplicate: true,
      isEmailChecked: false,
      isUsernameChecked: false,
      isPasswordChecked: false,
      termsAgreed: false
    }
  },
  methods: {
    ...mapActions(['doRefreshToken', 'fetchUserInfo']),
    ...mapGetters(['isAccessTokenExpired']),
    checkUsername() {
      if (usernameCheck.test(this.username)) {
        this.isUsernameChecked = true
      } else {
        this.isUsernameChecked = false
      }
    },
    checkPassword() {
      if (passwordCheck.test(this.password)) {
        this.isPasswordChecked = true
      } else {
        this.isPasswordChecked = false
      }
    },
    checkEmail() {
      if (emailCheck.test(this.email)) {
        this.isEmailChecked = true
      } else {
        this.isEmailChecked = false
      }
    },
    isUsernameDuplicate() {
      axios
        .get(BASE_URL + '/api/v1/user/auth/check/username/' + this.username)
        .then((res) => {
          if (res.data === false) {
            this.usernameDuplicate = false
            swal({
              title: 'ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤',
              text: '',
              icon: 'success',
              buttons: false,
              timer: 1500
            })
          } else {
            this.usernameDuplicate = true
            swal({
              title: 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤ğŸ˜¥',
              text: '',
              icon: 'warning',
              buttons: false,
              timer: 1500
            })
          }
        })
        .catch((err) => {
          console.log(err)
        })
    },
    isEmailDuplicate() {
      if (!emailCheck.test(this.email)) {
        swal({
          title: 'ì •í™•í•œ ì´ë©”ì¼ ì£¼ì†Œì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!',
          text: '',
          icon: 'warning',
          buttons: false,
          timer: 1500
        })
      } else {
        axios
          .get(BASE_URL + '/api/v1/user/auth/check/email/' + this.email, {
            email: this.email
          })
          .then((res) => {
            if (res.data === false) {
              this.emailDuplicate = false
              swal({
                title: 'ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë©”ì¼ì…ë‹ˆë‹¤',
                text: '',
                icon: 'success',
                buttons: false,
                timer: 1500
              })
            } else {
              this.emailDuplicate = true
              swal({
                title: 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤ğŸ˜¥',
                text: '',
                icon: 'warning',
                buttons: false,
                timer: 1500
              })
            }
          })
          .catch((err) => {
            console.log(err)
          })
      }
    },
    login() {
      axios
        .post(
          BASE_URL + '/api/v1/user/auth/login',
          {
            username: this.username,
            password: this.password
          },
          {
            headers: {
              'Content-Type': 'application/json'
            }
          }
        )
        .then((result) => {
          localStorage.setItem('accessToken', result.data.accessToken)
          localStorage.setItem('refreshToken', result.data.refreshToken)
          const option = {
            headers: {
              AUTHORIZATION: 'Bearer ' + localStorage.getItem('accessToken')
            }
          }
          axios.get(BASE_URL + '/api/v1/user/myinfo', option).then((res) => {
            this.fetchUserInfo(res.data)
            if (res.data.nickname === '') {
              this.$router.replace({ name: 'setnickname' })
            } else {
              this.$router.replace({ name: 'main' })
            }
          })
        })
    },
    cancel() {
      this.$router.replace('/')
    },
    signup() {
      if (this.termsAgreed === false) {
        swal({
          title: 'ì•½ê´€ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤',
          text: 'ì•½ê´€ì„ ì½ê³  ë™ì˜í•´ ì£¼ì„¸ìš”',
          icon: 'warning',
          buttons: false,
          timer: 1500
        })
      } else if (this.usernameDuplicate === true) {
        swal({
          title: 'ì•„ì´ë”” ì¤‘ë³µê²€ì‚¬ê°€ í•„ìš”í•©ë‹ˆë‹¤',
          text: 'ì•„ì´ë”” ì¤‘ë³µê²€ì‚¬ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”',
          icon: 'warning',
          buttons: false,
          timer: 1500
        })
      } else if (this.emailDuplicate === true) {
        swal({
          title: 'ì´ë©”ì¼ì¤‘ë³µê²€ì‚¬ê°€ í•„ìš”í•©ë‹ˆë‹¤',
          text: 'ì´ë©”ì¼ ì¤‘ë³µê²€ì‚¬ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”',
          icon: 'warning',
          buttons: false,
          timer: 1500
        })
      } else if (!passwordCheck.test(this.password)) {
        swal({
          title:
            'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸ì+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì ì¡°í•©ìœ¼ë¡œ 8~25ìë¦¬ë¥¼ ì‚¬ìš©í•´ì•¼ í•´ìš”',
          text: '',
          icon: 'warning',
          buttons: false,
          timer: 1500
        })
      } else if (!usernameCheck.test(this.username)) {
        swal({
          title: 'ì•„ì´ë””ëŠ” ì˜ë¬¸ìë‚˜ ìˆ«ìì˜ ì¡°í•©ìœ¼ë¡œ 5~20ìë¦¬ë¥¼ ì‚¬ìš©í•´ì•¼ í•´ìš”',
          text: '',
          icon: 'warning',
          buttons: false,
          timer: 1500
        })
      } else if (!emailCheck.test(this.email)) {
        swal({
          title: 'ì´ë©”ì¼ì´ ì¼ì¹˜í•˜ì§€ì•ŠìŠµë‹ˆë‹¤ì •í™•í•œ ì´ë©”ì¼ ì£¼ì†Œì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”',
          text: 'ì •í™•í•œ ì´ë©”ì¼ ì£¼ì†Œì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”',
          icon: 'warning',
          buttons: false,
          timer: 1500
        })
      } else if (this.password === this.password2) {
        axios
          .post(BASE_URL + '/api/v1/user/auth/signup', {
            email: this.email,
            nickname: this.nickname,
            password: this.password,
            region: this.region,
            username: this.username
          })
          .then(() => {
            swal({
              title: 'íšŒì›ê°€ì…ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!',
              text: '   ',
              icon: 'success',
              buttons: false,
              timer: 1500
            })
            this.login()
          })
          .catch((err) => {
            console.log(err)
          })
      } else {
        return swal({
          title: 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ìš”ğŸ˜¥',
          text: '',
          icon: 'warning',
          buttons: false,
          timer: 1500
        })
      }
    }
  }
  // watch: {
  //   username(newUsername) {
  //     this.usernameDuplicate = true
  //   },
  //   email(newEmail) {
  //     this.emailDuplicate = true
  //   }
  // }
}
</script>

<style scoped>
button {
  height: 4vh;
  border-radius: 50px;
  border: none;
  width: 10vw;
  margin: 10px;
  transition: 0.3s;
}
.duplicate__button:hover {
  background-color: #467302;
  color: white;
}
.background {
  height: 100vh;
  overflow: hidden;
  margin: 0;
  /* background-image: url('@/assets/game_background.png'); */
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
}
.signuppage {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  height: 100%;
  background-color: white;
}
.signuppage__left {
  margin-left: 20px;
  margin-right: 30px;
}
.signuppage__right {
  margin-right: 40px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.logo {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
}
.logo__img {
  width: 15vw;
}
.signup {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
}
.signup__btn {
  background-color: #a7c957;
  transition: 0.3s;
  height: 5vh;
}
.signup__btn:hover {
  background-color: #467302;
  color: white;
}
.cancel__btn {
  background-color: #bfbfbf;
  transition: 0.3s;
  height: 5vh;
}
.cancel__btn:hover {
  background-color: #ff4444;
  color: white;
}

.username__input,
.email__input {
  display: flex;
  flex-direction: row;
}

.usr__ipt {
  display: flex;
  flex-direction: column;
}

.email__ipt {
  display: flex;
  flex-direction: column;
}
.btn {
  display: flex;
  align-items: center;
}
.duplicate__button {
  /* display: table-cell; */
  height: 5vh;
  text-align: center;
  vertical-align: middle;
}
.username__input input {
  width: 20vw;
}

.email__input input {
  width: 20vw;
}

input {
  display: block;
  width: 30vw;
  height: 7vh;
  margin: 8px 0 8px 0;
  padding: 10px 15px 10px 25px;
  font-size: 16px;
  border: #ececec solid 2px;
  border-radius: 20px;
}
.termsofservice {
  width: 50vw;
  height: 30vw;
  margin: 20px;
  overflow: auto;
  background-image: url('@/assets/hanji.jpeg');
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center;
  display: flex;
  flex-direction: column;
  justify-content: center;
  border-radius: 50px;
}
.termsofservice__text {
  margin: 4vh;
  height: 40vh;
  flex-direction: column;
  justify-content: center;
}

.checkbox {
  width: 2vw;
  margin: 0;
  margin-left: 0.5vw;
  height: 3vh;
}
.checkbox__label {
  display: flex;
  flex-direction: row;
  justify-content: right;
  text-align: center;
  align-items: center;
}

.agreement {
  display: flex;
  flex-direction: row;
  justify-content: right;
  text-align: center;
  margin-right: 3vw;
}
.checkbox__text {
  display: flex;
  flex-direction: row;
  justify-content: right;
  text-align: center;
  margin-top: 1vh;
  margin-right: 3vw;
}
.allowedtext {
  color: #29cd2e;
}
.warningtext {
  color: #be0000;
}

@media screen and (max-width: 850px) {
  .background {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  .signuppage {
    overflow: auto;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 90vw;
    height: 95%;
    background-color: white;
    border-radius: 40px;
  }
  .signuppage__left {
    margin-left: 5vw;
    margin-right: 5vw;
    margin-top: 35vh;
  }
  .termsofservice {
    width: 75vw;
    height: 30vh;
    margin: 5vw;
    margin-top: 10vh;
    margin-bottom: 0;
    /* background-image: url('@/assets/hanji.jpeg'); */
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border-radius: 50px;
  }
  .termsofservice__text {
    overflow: auto;
    height: 35vh;
    margin: 5vw;
    flex-direction: column;
    justify-content: center;
    text-align: center;
  }
  .checkbox {
    width: 6vw;
    margin: 0;
    margin-left: 0.5vw;
    height: 3vh;
  }
  .checkbox__label {
    display: flex;
    flex-direction: row;
    justify-content: right;
    text-align: center;
    align-items: center;
    margin-right: 2vw;
  }

  .agreement {
    display: flex;
    flex-direction: row;
    justify-content: right;
    text-align: center;
    margin-top: 1vh;
    margin-right: 5vw;
  }
  .checkbox__text {
    display: flex;
    flex-direction: row;
    justify-content: right;
    text-align: center;
    margin-top: 1vh;
    margin-right: 5vw;
  }

  .signuppage__right {
    margin-left: 5vw;
    margin-right: 5vw;
    width: 80vw;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  .logo__img {
    width: 60vw;
  }
  input {
    width: 80vw;
    height: 7vh;
    font-size: 1.5vh;
    background-size: 3vw 3vw;
    padding-left: 4vw;
  }
  .oktext {
    margin-left: 3vw;
  }
  button {
    height: 5vh;
    border-radius: 50px;
    border: none;
    width: 35vw;
    margin-left: 0;
    margin-right: 0;
    margin-top: 1vh;
    margin-bottom: 1vh;
  }
  .signup__btn {
    background-color: #a7c957;
    transition: 0.3s;
    height: 6vh;
    margin-left: 2vw;
  }
  .cancel__btn {
    background-color: #bfbfbf;
    transition: 0.3s;
    height: 6vh;
    margin-right: 2vw;
  }
}
</style>
